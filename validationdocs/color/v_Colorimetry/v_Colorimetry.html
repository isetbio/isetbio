
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>v_Colorimetry</title><meta name="generator" content="MATLAB 8.4"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2015-04-14"><meta name="DC.source" content="v_Colorimetry.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#2">Function implementing the isetbio validation code</a></li><li><a href="#4">Path stuff</a></li><li><a href="#5">SETUP</a></li><li><a href="#6">XYZ-related colorimetry</a></li><li><a href="#7">xyY</a></li><li><a href="#8">CIE uv chromaticity</a></li><li><a href="#9">CIELUV</a></li><li><a href="#10">CIELAB</a></li><li><a href="#11">sRGB</a></li><li><a href="#12">Quanta/Energy</a></li><li><a href="#13">CIE daylights</a></li><li><a href="#14">Plotting</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> varargout = v_Colorimetry(varargin)
<span class="comment">%</span>
<span class="comment">%  Validate ISETBIO-based colorimetric computations by comparing to PTB-based colorimetric computations.</span>
<span class="comment">%</span>

    varargout = UnitTest.runValidationRun(@ValidationFunction, nargout, varargin);
<span class="keyword">end</span>
</pre><h2>Function implementing the isetbio validation code<a name="2"></a></h2><pre class="codeinput"><span class="keyword">function</span> ValidationFunction(runTimeParams)
</pre><h2>Path stuff<a name="4"></a></h2><p>Use ISETBIO's version of lab2xyz, otherwise the new Matlab function of the same name clobbers this and we get screwy answers.</p><p>Probably in the longer run should just use Matlab's version if it gives the same answers. (Changed isetbio to ieLAB2XYZ). lab2xyz = overrideBuiltInFunction('lab2xyz', 'isetbio');</p><h2>SETUP<a name="5"></a></h2><pre class="codeinput">    isetbioPath = fileparts(which(<span class="string">'colorTransformMatrix'</span>));
    curDir = pwd;
    tolerance = 1e-12;
</pre><h2>XYZ-related colorimetry<a name="6"></a></h2><pre class="codeinput">    UnitTest.validationRecord(<span class="string">'SIMPLE_MESSAGE'</span>, <span class="string">'***** Basic XYZ *****'</span>);
    testXYZs = [[1 2 1]' [2 1 0.5]' [1 1 1]' [0.6 2.3 4]'];
    ptbxyYs = XYZToxyY(testXYZs);
    ptbxys  = ptbxyYs(1:2,:);
    isetxys = chromaticity(testXYZs')';
    quantityOfInterest = ptbxys-isetxys;
    UnitTest.assertIsZero(quantityOfInterest,<span class="string">'PTB-ISET DIFFERENCE for XYZ to xy'</span>,tolerance);

    <span class="comment">% Append to validationData</span>
    UnitTest.validationData(<span class="string">'testXYZs'</span>, testXYZs);
    UnitTest.validationData(<span class="string">'ptbxys'</span>, ptbxys);
    UnitTest.validationData(<span class="string">'isetxys'</span>,isetxys);
</pre><h2>xyY<a name="7"></a></h2><pre class="codeinput">    ptbXYZs = xyYToXYZ(ptbxyYs);
    quantityOfInterest = testXYZs-ptbXYZs;
    UnitTest.assertIsZero(quantityOfInterest,<span class="string">'PTB XYZ to xyY to XYZ'</span>,tolerance);

    <span class="comment">% append to validationData</span>
    UnitTest.validationData(<span class="string">'ptbXYZs'</span>, ptbXYZs);

    isetXYZs = xyy2xyz(ptbxyYs')';
    quantityOfInterest = testXYZs-isetXYZs;
    UnitTest.assertIsZero(quantityOfInterest,<span class="string">'PTB-ISET DIFFERENCE for xyY to XYZ'</span>,tolerance);

    <span class="comment">% append to validationData</span>
    UnitTest.validationData(<span class="string">'isetXYZs'</span>, isetXYZs);
</pre><h2>CIE uv chromaticity<a name="8"></a></h2><pre class="codeinput">    ptbuvYs = XYZTouvY(testXYZs);
    ptbuvs = ptbuvYs(1:2,:);
    [isetus,isetvs] = xyz2uv(testXYZs');
    isetuvs = [isetus' ; isetvs'];
    <span class="keyword">if</span> (any(abs(ptbuvs-isetuvs) &gt; tolerance))
        message = sprintf(<span class="string">'PTB-ISET DIFFERENCE for XYZ to uv (tolerance: %g)'</span>, tolerance);
        message = sprintf(<span class="string">'%s\n\tI think this is because ISET implements an obsolete version of the standard'</span>, message);
        UnitTest.validationRecord(<span class="string">'FAILED'</span>, message);
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'PTB-ISET AGREE for XYZ to uv (tolerance: %g)'</span>, tolerance);
        UnitTest.validationRecord(<span class="string">'PASSED'</span>, message);
    <span class="keyword">end</span>
     <span class="comment">% append to validationData</span>
    UnitTest.validationData(<span class="string">'ptbuvs'</span>, ptbuvs);
    UnitTest.validationData(<span class="string">'isetuvs'</span>, isetuvs);
</pre><h2>CIELUV<a name="9"></a></h2><pre class="codeinput">    whiteXYZ = [3,4,3]';
    ptbLuvs = XYZToLuv(testXYZs,whiteXYZ);
    isetLuvs = xyz2luv(testXYZs',whiteXYZ')';
    <span class="keyword">if</span> (any(abs(ptbLuvs-isetLuvs) &gt; tolerance))
        message = sprintf(<span class="string">'PTB-ISET DIFFERENCE for XYZ to Luv (tolerance: %g)'</span>, tolerance);
        message = sprintf(<span class="string">'%s\n\tPresumably because the uv transformation differs.'</span>, message);
        UnitTest.validationRecord(<span class="string">'FAILED'</span>, message);
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'PTB-ISET AGREE for XYZ to Luv (tolerance: %g)'</span>, tolerance);
        UnitTest.validationRecord(<span class="string">'PASSED'</span>, message);
    <span class="keyword">end</span>

    <span class="comment">% update tovalidationData</span>
    UnitTest.validationData(<span class="string">'whiteXYZ'</span>, whiteXYZ);
    UnitTest.validationData(<span class="string">'ptbLuvs'</span>,  ptbLuvs);
    UnitTest.validationData(<span class="string">'isetLuvs'</span>, isetLuvs);
</pre><h2>CIELAB<a name="10"></a></h2><pre class="codeinput">    whiteXYZ = [3,4,3]';
    ptbLabs = XYZToLab(testXYZs,whiteXYZ);
    cd(isetbioPath);
    isetLabs = ieXYZ2LAB(testXYZs',whiteXYZ')';
    cd(curDir);

    quantityOfInterest = ptbLabs-isetLabs;
    UnitTest.assertIsZero(quantityOfInterest,<span class="string">'PTB-ISET DIFFERENCE for XYZ to Lab'</span>,tolerance);

    <span class="comment">% append to validationData</span>
    UnitTest.validationData(<span class="string">'ptbLabs'</span>,  ptbLabs);
    UnitTest.validationData(<span class="string">'isetLabs'</span>, isetLabs);

    ptbXYZCheck = LabToXYZ(ptbLabs,whiteXYZ);
    isetXYZCheck = ieLAB2XYZ(isetLabs',whiteXYZ')';

    quantityOfInterest = testXYZs-ptbXYZCheck;
    UnitTest.assertIsZero(quantityOfInterest,<span class="string">'PTB XYZ to Lab to XYZ'</span>,tolerance);

    <span class="comment">% update to validationData</span>
    UnitTest.validationData(<span class="string">'ptbXYZCheck'</span>, ptbXYZCheck);

    quantityOfInterest = testXYZs-isetXYZCheck;
    UnitTest.assertIsZero(quantityOfInterest,<span class="string">'ISET XYZ to Lab to XYZ'</span>,tolerance);

    <span class="comment">% append to validationData</span>
    UnitTest.validationData(<span class="string">'isetXYZCheck'</span>, isetXYZCheck);
</pre><h2>sRGB<a name="11"></a></h2><p>The iset routines seem to use a matrix that is 1/100 of the standard definition.  Or, at least, 1/100 of what the PTB routines use.  To account for this, I multiply XYZ values by 100 before passing them to the iset routines.</p><p>The iset routines take an exponent argument for the sRGB gamma transform. At <a href="http://www.w3.org/Graphics/Color/sRGB">http://www.w3.org/Graphics/Color/sRGB</a> this is specified as 2.4.  The iset routine xyz2srgb uses 2.2, with a comment that an update at www.srgb.com changed this from 2.4 to 2.2.  I think this is wrong, though.  The text I can find on the web says that the 2.4 exponent, plus the linear initial region, is designed to approximate a gamma of 2.2. That is, you want 2.4 in the formulae to approximate the 2.2 industry standard gamma.  Site www.srgb.com now appears gone, by the way, but all the other sites I find seem to be the same in this regard.</p><p>Also note that if you change the exponent in the iset sRGB formulae, you also should probably change the cutoff used at the low-end, where the sRGB standard special cases the functional form of the gamma curve.  Here the test is set for 2.4.</p><p>Finally,the default gamma used by iset lrgb2srgb and by xzy2srgb currently differ, so you really want to be careful using these.  The inverse routine srgb2lrgb doesn't allow passing of the exponent, and it is hard coded as 2.4.  This causes a failure of the iset sRGB gamma routines to self-invert for gamma other than 2.4, and with their defaults.</p><p>One other convention difference is that the PTB routine rounds to integers for the settings, while the iset routine leaves the rounding up to the caller.</p><pre class="codeinput">    UnitTest.validationRecord(<span class="string">'SIMPLE_MESSAGE'</span>, <span class="string">'***** sRGB *****'</span>);

    <span class="comment">% Create some test sRGB values and convert them in the PTB framework</span>
    ptbSRGBs = [[188 188 188]' [124 218 89]' [255 149 203]' [255 3 203]'];
    ptbSRGBPrimary = SRGBGammaUncorrect(ptbSRGBs);
    ptbXYZs = SRGBPrimaryToXYZ(ptbSRGBPrimary);

    <span class="comment">% The ISET form takes the frame buffer values in the [0,1] regime</span>
    isetSRGBs = ptbSRGBs/255;
    isetSRGBs = XW2RGBFormat(isetSRGBs',4,1);
    isetXYZ   = srgb2xyz(isetSRGBs);
    isetXYZs  = RGB2XWFormat(isetXYZ)';

    <span class="keyword">if</span> (any(abs(isetXYZs-ptbXYZs) &gt; tolerance))
        d = isetXYZs - ptbXYZs;
        message = sprintf(<span class="string">'PTB-ISET DIFFERENCE for XYZ to sRGB: %f (tolerance: %g)'</span>,max(abs(d(:))), tolerance);
        d = d ./ptbXYZs;
        message = sprintf(<span class="string">'%s\nPTB-ISET Percent XYZ DIFFERENCE: %f\n'</span>, message, max(abs(d(:))));
        UnitTest.validationRecord(<span class="string">'FAILED'</span>, message);
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'PTB-ISET AGREE for XYZ to sRGB (tolerance: %g)'</span>, tolerance);
        UnitTest.validationRecord(<span class="string">'PASSED'</span>, message);
    <span class="keyword">end</span>
    <span class="comment">% append to validationData</span>
    UnitTest.validationData(<span class="string">'isetXYZs_2'</span>, isetXYZs);
    UnitTest.validationData(<span class="string">'ptbXYZs_2'</span>, ptbXYZs);

    <span class="comment">% PTB testing of inversion</span>
    quantityOfInterest = XYZToSRGBPrimary(ptbXYZs)-ptbSRGBPrimary;
    UnitTest.assertIsZero(quantityOfInterest,<span class="string">'PTB linear sRGB to XYZ to linear sRGB'</span>,tolerance);

    <span class="comment">% append to validationData</span>
    UnitTest.validationData(<span class="string">'ptbSRGBPrimary'</span>, ptbSRGBPrimary);

    quantityOfInterest = SRGBGammaCorrect(ptbSRGBPrimary)-ptbSRGBs;
    UnitTest.assertIsZero(quantityOfInterest,<span class="string">'sRGB to linear sRGB to sRGB'</span>,tolerance);

    <span class="comment">% append to validationData</span>
    UnitTest.validationData(<span class="string">'ptbSRGBs'</span>, ptbSRGBs);

    <span class="comment">% Compare sRGB matrices</span>
    [nil,ptbSRGBMatrix] = XYZToSRGBPrimary([]);
    isetSRGBMatrix = colorTransformMatrix(<span class="string">'xyz2srgb'</span>)';

    quantityOfInterest = ptbSRGBMatrix-isetSRGBMatrix;
    UnitTest.assertIsZero(quantityOfInterest,<span class="string">'PTB-ISET DIFFERENCE for sRGB transform matrix'</span>,tolerance);

    <span class="comment">% append to validationData</span>
    UnitTest.validationData(<span class="string">'ptbSRGBMatrix'</span>, ptbSRGBMatrix);
    UnitTest.validationData(<span class="string">'isetSRGBMatrix'</span>, isetSRGBMatrix);

    <span class="comment">% XYZ -&gt; lRGB</span>
    <span class="comment">% Reformat shape</span>
    ptbXYZsImage = CalFormatToImage(ptbXYZs,1,size(ptbXYZs,2));

    <span class="comment">% ISET convert</span>
    [isetSRGBImage,isetSRGBPrimaryImage] = xyz2srgb(ptbXYZsImage);

    <span class="comment">% Reformat shape</span>
    isetSRGBs = ImageToCalFormat(isetSRGBImage);
    isetSRGBPrimary = ImageToCalFormat(isetSRGBPrimaryImage);

    <span class="keyword">if</span> (any(abs(ptbSRGBPrimary-isetSRGBPrimary) &gt; tolerance))
        d = ptbSRGBPrimary - isetSRGBPrimary;
        message = sprintf(<span class="string">'PTB-ISET DIFFERENCE for XYZ to sRGB: %f (tolerance: %g)'</span>,max(abs(d(:))), tolerance);
        d = d ./isetSRGBPrimary;
        message = sprintf(<span class="string">'%s\n\t\tPTB-ISET Percent RGB DIFFERENCE: %f'</span>, message, max(abs(d(:))));
        UnitTest.validationRecord(<span class="string">'FAILED'</span>, message);
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'PTB-ISET AGREE for XYZ to linear sRGB (tolerance: %g)'</span>, tolerance);
        UnitTest.validationRecord(<span class="string">'PASSED'</span>, message);
    <span class="keyword">end</span>
    <span class="comment">% append to validationData</span>
    UnitTest.validationData(<span class="string">'ptbSRGBPrimary_2'</span>, ptbSRGBPrimary);
    UnitTest.validationData(<span class="string">'isetSRGBPrimary_2'</span>, isetSRGBPrimary);


    <span class="comment">% ISET/PTB sRGB comparison in integer gamma corrected space</span>
    quantityOfInterest = round(isetSRGBs*255)-ptbSRGBs;
    UnitTest.assertIsZero(quantityOfInterest,<span class="string">'PTB-ISET DIFFERENCE for XYZ to sRGB'</span>,tolerance);

    <span class="comment">% append to validationData</span>
    UnitTest.validationData(<span class="string">'isetSRGBs'</span>, isetSRGBs*255);
    UnitTest.validationData(<span class="string">'ptbSRGBs_2'</span>, ptbSRGBs);


    <span class="comment">% lrgb -&gt; srgb -&gt; lrgb in ISET</span>
    isetSRGBPrimaryCheckImage = srgb2lrgb(isetSRGBImage);
    isetSRGBPrimaryCheck = ImageToCalFormat(isetSRGBPrimaryCheckImage);
    quantityOfInterest = isetSRGBPrimaryCheck-isetSRGBPrimary;
    UnitTest.assertIsZero(quantityOfInterest,<span class="string">'ISET linear sRGB to sRGB to linear sRGB'</span>,tolerance);

    <span class="comment">% append to validationData</span>
    UnitTest.validationData(<span class="string">'isetSRGBPrimaryCheck'</span>, isetSRGBPrimaryCheck);
    UnitTest.validationData(<span class="string">'isetSRGBPrimary'</span>, isetSRGBPrimary);
</pre><h2>Quanta/Energy<a name="12"></a></h2><p>The ISET routines define c and h to more places than the PTB, so the agreement is only good to about 5 significant places.  Seems OK to me.</p><pre class="codeinput">    UnitTest.validationRecord(<span class="string">'SIMPLE_MESSAGE'</span>, <span class="string">'***** Energy/Quanta *****'</span>);

    load <span class="string">spd_D65</span>
    spdEnergyTest = spd_D65;
    wlsTest = SToWls(S_D65);
    testPlaces = 5;
    ptbQuanta = EnergyToQuanta(wlsTest,spdEnergyTest);
    isetQuanta = Energy2Quanta(wlsTest,spdEnergyTest);
    toleranceQuanta = (10^-testPlaces)*min(ptbQuanta);
    <span class="keyword">if</span> (any(abs(ptbQuanta-isetQuanta) &gt; toleranceQuanta))
        message = sprintf(<span class="string">'PTB-ISET DO NOT AGREE for energy to quanta conversion at %d significant places (tolerance: %0.1g quanta)'</span>,testPlaces, toleranceQuanta);
        UnitTest.validationRecord(<span class="string">'FAILED'</span>, message);
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'PTB-ISET AGREE for energy to quanta conversion to %d significant places (tolerance: %0.1g quanta)'</span>,testPlaces,  toleranceQuanta);
        UnitTest.validationRecord(<span class="string">'PASSED'</span>, message);
    <span class="keyword">end</span>
    <span class="comment">% append to validationData</span>
    UnitTest.validationData(<span class="string">'ptbQuanta'</span>, ptbQuanta);
    UnitTest.validationData(<span class="string">'isetQuanta'</span>, isetQuanta);

    quantityOfInterest = QuantaToEnergy(wlsTest,ptbQuanta)-spdEnergyTest;
    UnitTest.assertIsZero(quantityOfInterest,<span class="string">'PTB energy to quanta to energy'</span>,tolerance);

    <span class="comment">% append to validationData</span>
    UnitTest.validationData(<span class="string">'ptbEnergyFromQuanta'</span>, QuantaToEnergy(wlsTest,ptbQuanta));
    UnitTest.validationData(<span class="string">'spdEnergyTest'</span>, spdEnergyTest);

    quantityOfInterest = Quanta2Energy(wlsTest,isetQuanta')'- spdEnergyTest;
    UnitTest.assertIsZero(quantityOfInterest,<span class="string">'ISET energy to quanta to energy'</span>,tolerance);

    <span class="comment">% append to validationData</span>
    UnitTest.validationData(<span class="string">'isetEnergyFromQuanta'</span>, Quanta2Energy(wlsTest,isetQuanta')');
</pre><h2>CIE daylights<a name="13"></a></h2><p>These routines are now running in ISET and everything agrees.</p><pre class="codeinput">    UnitTest.validationRecord(<span class="string">'SIMPLE_MESSAGE'</span>, <span class="string">'***** CIE Daylights *****'</span>);

    load <span class="string">B_cieday</span>
    testWls = SToWls(S_cieday);
    testTemp = 4987;
    ptbDaySpd = GenerateCIEDay(testTemp,B_cieday);
    ptbDaySpd = ptbDaySpd/max(ptbDaySpd(:));

    <span class="comment">% Iset version of normalized daylight</span>
    isetDaySpd = daylight(testWls,testTemp);
    isetDaySpd = isetDaySpd/max(isetDaySpd(:));

    quantityOfInterest = isetDaySpd-ptbDaySpd;
    UnitTest.assertIsZero(quantityOfInterest,<span class="string">'PTB-ISET DIFFERENCE for daylight'</span>,tolerance);

    <span class="comment">% append to validationData</span>
    UnitTest.validationData(<span class="string">'isetDaySpd'</span>, isetDaySpd);
    UnitTest.validationData(<span class="string">'ptbDaySpd'</span>,  ptbDaySpd);
</pre><h2>Plotting<a name="14"></a></h2><pre class="codeinput">    <span class="keyword">if</span> (runTimeParams.generatePlots)

    <span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014b</a><br></p></div><!--
##### SOURCE BEGIN #####
function varargout = v_Colorimetry(varargin)
%
%  Validate ISETBIO-based colorimetric computations by comparing to PTB-based colorimetric computations.
%

    varargout = UnitTest.runValidationRun(@ValidationFunction, nargout, varargin);
end

%% Function implementing the isetbio validation code
function ValidationFunction(runTimeParams)
    
    %% Path stuff
    % Use ISETBIO's version of lab2xyz, otherwise the new
    % Matlab function of the same name clobbers this and we
    % get screwy answers.
    %
    % Probably in the longer run should just use Matlab's version if it gives
    % the same answers. 
    % (Changed isetbio to ieLAB2XYZ).
    % lab2xyz = overrideBuiltInFunction('lab2xyz', 'isetbio');
    
    %% SETUP
    isetbioPath = fileparts(which('colorTransformMatrix'));
    curDir = pwd; 
    tolerance = 1e-12;
    
    %% XYZ-related colorimetry
    UnitTest.validationRecord('SIMPLE_MESSAGE', '***** Basic XYZ *****');
    testXYZs = [[1 2 1]' [2 1 0.5]' [1 1 1]' [0.6 2.3 4]'];
    ptbxyYs = XYZToxyY(testXYZs);
    ptbxys  = ptbxyYs(1:2,:);
    isetxys = chromaticity(testXYZs')';
    quantityOfInterest = ptbxys-isetxys;
    UnitTest.assertIsZero(quantityOfInterest,'PTB-ISET DIFFERENCE for XYZ to xy',tolerance);
    
    % Append to validationData 
    UnitTest.validationData('testXYZs', testXYZs);
    UnitTest.validationData('ptbxys', ptbxys);
    UnitTest.validationData('isetxys',isetxys);
    
    %% xyY
    ptbXYZs = xyYToXYZ(ptbxyYs);
    quantityOfInterest = testXYZs-ptbXYZs;
    UnitTest.assertIsZero(quantityOfInterest,'PTB XYZ to xyY to XYZ',tolerance);

    % append to validationData 
    UnitTest.validationData('ptbXYZs', ptbXYZs);
    
    isetXYZs = xyy2xyz(ptbxyYs')';
    quantityOfInterest = testXYZs-isetXYZs;
    UnitTest.assertIsZero(quantityOfInterest,'PTB-ISET DIFFERENCE for xyY to XYZ',tolerance);
    
    % append to validationData 
    UnitTest.validationData('isetXYZs', isetXYZs);
 
    %% CIE uv chromaticity
    ptbuvYs = XYZTouvY(testXYZs);
    ptbuvs = ptbuvYs(1:2,:);
    [isetus,isetvs] = xyz2uv(testXYZs');
    isetuvs = [isetus' ; isetvs'];
    if (any(abs(ptbuvs-isetuvs) > tolerance))
        message = sprintf('PTB-ISET DIFFERENCE for XYZ to uv (tolerance: %g)', tolerance);
        message = sprintf('%s\n\tI think this is because ISET implements an obsolete version of the standard', message);
        UnitTest.validationRecord('FAILED', message);
    else
        message = sprintf('PTB-ISET AGREE for XYZ to uv (tolerance: %g)', tolerance);
        UnitTest.validationRecord('PASSED', message);
    end
     % append to validationData 
    UnitTest.validationData('ptbuvs', ptbuvs);
    UnitTest.validationData('isetuvs', isetuvs);
    
    %% CIELUV
    whiteXYZ = [3,4,3]';
    ptbLuvs = XYZToLuv(testXYZs,whiteXYZ);
    isetLuvs = xyz2luv(testXYZs',whiteXYZ')';
    if (any(abs(ptbLuvs-isetLuvs) > tolerance))
        message = sprintf('PTB-ISET DIFFERENCE for XYZ to Luv (tolerance: %g)', tolerance);
        message = sprintf('%s\n\tPresumably because the uv transformation differs.', message);
        UnitTest.validationRecord('FAILED', message);
    else
        message = sprintf('PTB-ISET AGREE for XYZ to Luv (tolerance: %g)', tolerance);
        UnitTest.validationRecord('PASSED', message);
    end
    
    % update tovalidationData
    UnitTest.validationData('whiteXYZ', whiteXYZ);
    UnitTest.validationData('ptbLuvs',  ptbLuvs);
    UnitTest.validationData('isetLuvs', isetLuvs);
    
    %% CIELAB
    whiteXYZ = [3,4,3]';
    ptbLabs = XYZToLab(testXYZs,whiteXYZ);
    cd(isetbioPath);
    isetLabs = ieXYZ2LAB(testXYZs',whiteXYZ')';
    cd(curDir);
    
    quantityOfInterest = ptbLabs-isetLabs;
    UnitTest.assertIsZero(quantityOfInterest,'PTB-ISET DIFFERENCE for XYZ to Lab',tolerance);

    % append to validationData
    UnitTest.validationData('ptbLabs',  ptbLabs);
    UnitTest.validationData('isetLabs', isetLabs);
    
    ptbXYZCheck = LabToXYZ(ptbLabs,whiteXYZ);
    isetXYZCheck = ieLAB2XYZ(isetLabs',whiteXYZ')';
    
    quantityOfInterest = testXYZs-ptbXYZCheck;
    UnitTest.assertIsZero(quantityOfInterest,'PTB XYZ to Lab to XYZ',tolerance);
  
    % update to validationData
    UnitTest.validationData('ptbXYZCheck', ptbXYZCheck);
    
    quantityOfInterest = testXYZs-isetXYZCheck;
    UnitTest.assertIsZero(quantityOfInterest,'ISET XYZ to Lab to XYZ',tolerance);
   
    % append to validationData
    UnitTest.validationData('isetXYZCheck', isetXYZCheck);

    
    %% sRGB
    %
    % The iset routines seem to use a matrix that is 1/100 of the standard
    % definition.  Or, at least, 1/100 of what the PTB routines use.  To
    % account for this, I multiply XYZ values by 100 before passing them
    % to the iset routines.
    %
    % The iset routines take an exponent argument for the sRGB gamma transform.
    % At http://www.w3.org/Graphics/Color/sRGB this is specified as 2.4.  The
    % iset routine xyz2srgb uses 2.2, with a comment that an update at
    % www.srgb.com changed this from 2.4 to 2.2.  I think this is wrong,
    % though.  The text I can find on the web says that the 2.4 exponent, plus
    % the linear initial region, is designed to approximate a gamma of 2.2.
    % That is, you want 2.4 in the formulae to approximate the 2.2 industry
    % standard gamma.  Site www.srgb.com now appears gone, by the way, but all
    % the other sites I find seem to be the same in this regard.
    % 
    % Also note that if you change the exponent in the iset sRGB formulae, you
    % also should probably change the cutoff used at the low-end, where the
    % sRGB standard special cases the functional form of the gamma curve.  Here
    % the test is set for 2.4.
    %
    % Finally,the default gamma used by iset lrgb2srgb and by xzy2srgb
    % currently differ, so you really want to be careful using these.  The
    % inverse routine srgb2lrgb doesn't allow passing of the exponent, and it
    % is hard coded as 2.4.  This causes a failure of the iset sRGB gamma
    % routines to self-invert for gamma other than 2.4, and with their
    % defaults.
    %
    % One other convention difference is that the PTB routine rounds to
    % integers for the settings, while the iset routine leaves the rounding up
    % to the caller.
    UnitTest.validationRecord('SIMPLE_MESSAGE', '***** sRGB *****');

    % Create some test sRGB values and convert them in the PTB framework
    ptbSRGBs = [[188 188 188]' [124 218 89]' [255 149 203]' [255 3 203]'];
    ptbSRGBPrimary = SRGBGammaUncorrect(ptbSRGBs);
    ptbXYZs = SRGBPrimaryToXYZ(ptbSRGBPrimary);

    % The ISET form takes the frame buffer values in the [0,1] regime
    isetSRGBs = ptbSRGBs/255;
    isetSRGBs = XW2RGBFormat(isetSRGBs',4,1);
    isetXYZ   = srgb2xyz(isetSRGBs);
    isetXYZs  = RGB2XWFormat(isetXYZ)';

    if (any(abs(isetXYZs-ptbXYZs) > tolerance))
        d = isetXYZs - ptbXYZs;
        message = sprintf('PTB-ISET DIFFERENCE for XYZ to sRGB: %f (tolerance: %g)',max(abs(d(:))), tolerance);
        d = d ./ptbXYZs;
        message = sprintf('%s\nPTB-ISET Percent XYZ DIFFERENCE: %f\n', message, max(abs(d(:))));
        UnitTest.validationRecord('FAILED', message);
    else
        message = sprintf('PTB-ISET AGREE for XYZ to sRGB (tolerance: %g)', tolerance);
        UnitTest.validationRecord('PASSED', message);
    end
    % append to validationData
    UnitTest.validationData('isetXYZs_2', isetXYZs);
    UnitTest.validationData('ptbXYZs_2', ptbXYZs);
    
    % PTB testing of inversion
    quantityOfInterest = XYZToSRGBPrimary(ptbXYZs)-ptbSRGBPrimary;
    UnitTest.assertIsZero(quantityOfInterest,'PTB linear sRGB to XYZ to linear sRGB',tolerance);

    % append to validationData
    UnitTest.validationData('ptbSRGBPrimary', ptbSRGBPrimary);
    
    quantityOfInterest = SRGBGammaCorrect(ptbSRGBPrimary)-ptbSRGBs;
    UnitTest.assertIsZero(quantityOfInterest,'sRGB to linear sRGB to sRGB',tolerance);
    
    % append to validationData
    UnitTest.validationData('ptbSRGBs', ptbSRGBs);
    
    % Compare sRGB matrices
    [nil,ptbSRGBMatrix] = XYZToSRGBPrimary([]);
    isetSRGBMatrix = colorTransformMatrix('xyz2srgb')';

    quantityOfInterest = ptbSRGBMatrix-isetSRGBMatrix;
    UnitTest.assertIsZero(quantityOfInterest,'PTB-ISET DIFFERENCE for sRGB transform matrix',tolerance);

    % append to validationData
    UnitTest.validationData('ptbSRGBMatrix', ptbSRGBMatrix);
    UnitTest.validationData('isetSRGBMatrix', isetSRGBMatrix);
    
    % XYZ -> lRGB 
    % Reformat shape
    ptbXYZsImage = CalFormatToImage(ptbXYZs,1,size(ptbXYZs,2));

    % ISET convert 
    [isetSRGBImage,isetSRGBPrimaryImage] = xyz2srgb(ptbXYZsImage);

    % Reformat shape
    isetSRGBs = ImageToCalFormat(isetSRGBImage); 
    isetSRGBPrimary = ImageToCalFormat(isetSRGBPrimaryImage);

    if (any(abs(ptbSRGBPrimary-isetSRGBPrimary) > tolerance))
        d = ptbSRGBPrimary - isetSRGBPrimary;
        message = sprintf('PTB-ISET DIFFERENCE for XYZ to sRGB: %f (tolerance: %g)',max(abs(d(:))), tolerance);
        d = d ./isetSRGBPrimary;
        message = sprintf('%s\n\t\tPTB-ISET Percent RGB DIFFERENCE: %f', message, max(abs(d(:))));
        UnitTest.validationRecord('FAILED', message);
    else
        message = sprintf('PTB-ISET AGREE for XYZ to linear sRGB (tolerance: %g)', tolerance);
        UnitTest.validationRecord('PASSED', message);
    end
    % append to validationData
    UnitTest.validationData('ptbSRGBPrimary_2', ptbSRGBPrimary);
    UnitTest.validationData('isetSRGBPrimary_2', isetSRGBPrimary);
    
    
    % ISET/PTB sRGB comparison in integer gamma corrected space
    quantityOfInterest = round(isetSRGBs*255)-ptbSRGBs;
    UnitTest.assertIsZero(quantityOfInterest,'PTB-ISET DIFFERENCE for XYZ to sRGB',tolerance);

    % append to validationData
    UnitTest.validationData('isetSRGBs', isetSRGBs*255);
    UnitTest.validationData('ptbSRGBs_2', ptbSRGBs);
    
    
    % lrgb -> srgb -> lrgb in ISET
    isetSRGBPrimaryCheckImage = srgb2lrgb(isetSRGBImage);
    isetSRGBPrimaryCheck = ImageToCalFormat(isetSRGBPrimaryCheckImage);
    quantityOfInterest = isetSRGBPrimaryCheck-isetSRGBPrimary;
    UnitTest.assertIsZero(quantityOfInterest,'ISET linear sRGB to sRGB to linear sRGB',tolerance);

    % append to validationData
    UnitTest.validationData('isetSRGBPrimaryCheck', isetSRGBPrimaryCheck);
    UnitTest.validationData('isetSRGBPrimary', isetSRGBPrimary);
    

    %% Quanta/Energy
    %
    % The ISET routines define c and h to more places than the PTB, so the
    % agreement is only good to about 5 significant places.  Seems OK to me.
    UnitTest.validationRecord('SIMPLE_MESSAGE', '***** Energy/Quanta *****');
    
    load spd_D65
    spdEnergyTest = spd_D65;
    wlsTest = SToWls(S_D65);
    testPlaces = 5;
    ptbQuanta = EnergyToQuanta(wlsTest,spdEnergyTest);
    isetQuanta = Energy2Quanta(wlsTest,spdEnergyTest);
    toleranceQuanta = (10^-testPlaces)*min(ptbQuanta);
    if (any(abs(ptbQuanta-isetQuanta) > toleranceQuanta))
        message = sprintf('PTB-ISET DO NOT AGREE for energy to quanta conversion at %d significant places (tolerance: %0.1g quanta)',testPlaces, toleranceQuanta);
        UnitTest.validationRecord('FAILED', message);
    else
        message = sprintf('PTB-ISET AGREE for energy to quanta conversion to %d significant places (tolerance: %0.1g quanta)',testPlaces,  toleranceQuanta);
        UnitTest.validationRecord('PASSED', message);
    end
    % append to validationData
    UnitTest.validationData('ptbQuanta', ptbQuanta);
    UnitTest.validationData('isetQuanta', isetQuanta);
    
    quantityOfInterest = QuantaToEnergy(wlsTest,ptbQuanta)-spdEnergyTest;
    UnitTest.assertIsZero(quantityOfInterest,'PTB energy to quanta to energy',tolerance);

    % append to validationData
    UnitTest.validationData('ptbEnergyFromQuanta', QuantaToEnergy(wlsTest,ptbQuanta));
    UnitTest.validationData('spdEnergyTest', spdEnergyTest);
    
    quantityOfInterest = Quanta2Energy(wlsTest,isetQuanta')'- spdEnergyTest;
    UnitTest.assertIsZero(quantityOfInterest,'ISET energy to quanta to energy',tolerance);
    
    % append to validationData
    UnitTest.validationData('isetEnergyFromQuanta', Quanta2Energy(wlsTest,isetQuanta')');
    
    %% CIE daylights
    % 
    % These routines are now running in ISET and everything agrees.
    UnitTest.validationRecord('SIMPLE_MESSAGE', '***** CIE Daylights *****');
    
    load B_cieday
    testWls = SToWls(S_cieday);
    testTemp = 4987;
    ptbDaySpd = GenerateCIEDay(testTemp,B_cieday);
    ptbDaySpd = ptbDaySpd/max(ptbDaySpd(:));

    % Iset version of normalized daylight
    isetDaySpd = daylight(testWls,testTemp);
    isetDaySpd = isetDaySpd/max(isetDaySpd(:));
    
    quantityOfInterest = isetDaySpd-ptbDaySpd;
    UnitTest.assertIsZero(quantityOfInterest,'PTB-ISET DIFFERENCE for daylight',tolerance);
    
    % append to validationData
    UnitTest.validationData('isetDaySpd', isetDaySpd);
    UnitTest.validationData('ptbDaySpd',  ptbDaySpd);
    
    %% Plotting
    if (runTimeParams.generatePlots)

    end
end




##### SOURCE END #####
--></body></html>