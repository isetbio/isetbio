
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>t_ColorMetamerism</title><meta name="generator" content="MATLAB 8.4"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2015-08-13"><meta name="DC.source" content="t_colorMetamerism.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>t_ColorMetamerism</h1><!--introduction--><p>Illustrate a metameric color match.</p><p>Simulate a uniform field with D65 spectral power distribution and a matching (metameric) LCD display.</p><p>Then use the two metamers to create a bar pattern.</p><p>Show how the bar pattern is represented after optical blurring and then captured by the human cone sensor array.</p><p>(c) Imageval Consulting, LLC 2012</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Initialize</a></li><li><a href="#2">Create a uniform scene with a D65 spectral power distribution</a></li><li><a href="#3">Create a uniform field with a metameric spectral power distribution.</a></li><li><a href="#4">Now read the Stockman cone wavelength sensitivities</a></li><li><a href="#5">Create a new uniform scene with the SPD that is metameric to D65</a></li><li><a href="#6">Numerical check</a></li><li><a href="#7">A spatial pattern with two metamers adjacent.</a></li><li><a href="#8">Compute the OI and show the SPD across a line in the image</a></li><li><a href="#9">Compute the sensor response for these half degree bars.</a></li><li><a href="#10">Now, reduce the fov so the bars are an eighth of a degree.</a></li><li><a href="#11">END</a></li></ul></div><h2>Initialize<a name="1"></a></h2><pre class="codeinput">ieInit;
</pre><h2>Create a uniform scene with a D65 spectral power distribution<a name="2"></a></h2><pre class="codeinput">uSize = 64;
uS = sceneCreate(<span class="string">'uniformd65'</span>,uSize);
vcAddAndSelectObject(uS); sceneWindow;
</pre><img vspace="5" hspace="5" src="t_colorMetamerism_01.png" alt=""> <h2>Create a uniform field with a metameric spectral power distribution.<a name="3"></a></h2><p>The new spectrum is the weighted sum of the primaries of an LCD. spectrum.  The weights are chosen so that the LCD has the same effect as the D65 on the cones.</p><p>This new SPD is a cone metameric match to the D65 in the original scene.</p><pre class="codeinput"><span class="comment">% The mean LMS cone values of the original</span>
lms = sceneGet(uS,<span class="string">'lms'</span>);
meanLMS = mean(RGB2XWFormat(lms));

<span class="comment">% Load a display and use the display primaries as a set of basis functions</span>
<span class="comment">% for the metameric light.</span>
d    = displayCreate(<span class="string">'LCD-Apple'</span>);
wave = sceneGet(uS,<span class="string">'wave'</span>);
displaySPD = displayGet(d,<span class="string">'spd'</span>,wave);

<span class="comment">% These are the display primaries</span>
vcNewGraphWin; plot(wave,displaySPD)
title(<span class="string">'Display primaries'</span>)
</pre><img vspace="5" hspace="5" src="t_colorMetamerism_02.png" alt=""> <h2>Now read the Stockman cone wavelength sensitivities<a name="4"></a></h2><pre class="codeinput">S = ieReadSpectra(<span class="string">'stockman'</span>,wave);
dW = wave(2)-wave(1);   <span class="comment">% Delta Wavelength</span>

<span class="comment">% Solve for the weights on the primaries that will produce the same</span>
<span class="comment">% absorptions in the cones as the D65 light.  Be careful to account for the</span>
<span class="comment">% wavelength sample spacing, dW.</span>
<span class="comment">%</span>
<span class="comment">%   meanLMS(:) = S'*(displaySPD*w)*dW</span>
<span class="comment">%</span>
w = ((S'*displaySPD)\meanLMS(:))/dW;
metamer = displaySPD*w;
</pre><h2>Create a new uniform scene with the SPD that is metameric to D65<a name="5"></a></h2><p>We do this using the sceneSPDScale routine.  This multiplies the SPD in the scene by another SPD.  We use the metamer/originalSPD as the multiplier.</p><pre class="codeinput"><span class="comment">% Here is the original</span>
oSPD = sceneGet(uS,<span class="string">'mean energy spd'</span>);

<span class="comment">% Divide by the original, and then multiply by the metamer</span>
uS2 = sceneSPDScale(uS,metamer(:)./oSPD(:),<span class="string">'*'</span>,0);
uS2 = sceneSet(uS2,<span class="string">'name'</span>,<span class="string">'metamer'</span>);

<span class="comment">% The metamer SPD</span>
mSPD = sceneGet(uS2,<span class="string">'mean energy spd'</span>);

<span class="comment">% Make a plot comparing the metamer and the original mean energy (mn)</span>
vcNewGraphWin;
plot(wave,mSPD,<span class="string">'-o'</span>,wave,oSPD,<span class="string">'--'</span>);
legend(<span class="string">'Metamer'</span>,<span class="string">'original'</span>)

<span class="comment">% Note that the color appearance on the screen differs between these two</span>
<span class="comment">% metamers.  That is because I did not implement a rendering algorithm</span>
<span class="comment">% based on human vision and the cones.  I used a method that is faster.  I</span>
<span class="comment">% am thinking of changing because, well, computers are now faster.</span>
vcAddAndSelectObject(uS2); sceneWindow;
</pre><img vspace="5" hspace="5" src="t_colorMetamerism_03.png" alt=""> <img vspace="5" hspace="5" src="t_colorMetamerism_04.png" alt=""> <h2>Numerical check<a name="6"></a></h2><p>The comparison projects of the SPDs of the metamers onto the Stockman cones.  The difference should be zero.  It is small, and I am not sure why it is not really zero.  I could probably do better.</p><pre class="codeinput">S'*(mSPD(:) - oSPD(:)) / norm(oSPD,2)
</pre><pre class="codeoutput">
ans =

   1.0e-07 *

    0.0912
    0.0352
   -0.3560

</pre><h2>A spatial pattern with two metamers adjacent.<a name="7"></a></h2><p>This will enable us to see the effect of optical blurring on the different spectral power distributions.</p><pre class="codeinput"><span class="comment">% Retrieve the SPD data from the two different uniform scenes.</span>
height = 64; width = 32;
xwData  = sceneGet(uS,<span class="string">'roi photons'</span>,  [8 8 width-1 height-1]);
xwData2 = sceneGet(uS2,<span class="string">'roi photons'</span>,[8 8 width-1 height-1]);

<span class="comment">% Combine the two data sets into one and attach it to a new scene</span>
cBar = XW2RGBFormat([xwData; xwData2],height,2*width);
barS = sceneSet(uS,<span class="string">'photons'</span>,cBar);

<span class="comment">% Name it, set the FOV, and show it.</span>
barS = sceneSet(barS,<span class="string">'name'</span>,<span class="string">'bars'</span>);
barS = sceneSet(barS,<span class="string">'h fov'</span>,1);
vcAddAndSelectObject(barS); sceneWindow;
</pre><img vspace="5" hspace="5" src="t_colorMetamerism_05.png" alt=""> <h2>Compute the OI and show the SPD across a line in the image<a name="8"></a></h2><p>Notice that the optical image spectral irradiance varies across the row. The LCD spectra are clearly seen at the positive positions.  They are blurred a little onto the left side by the optics.</p><pre class="codeinput">oi = oiCreate(<span class="string">'human'</span>);
oi = oiCompute(oi,barS);
vcNewGraphWin;
midRow = round(oiGet(oi,<span class="string">'rows'</span>)/2);
oiPlot(oi,<span class="string">'h line irradiance'</span>,[1,midRow]);
title(<span class="string">'1 cpd bar'</span>);
vcAddAndSelectObject(oi); oiWindow;
</pre><img vspace="5" hspace="5" src="t_colorMetamerism_06.png" alt=""> <img vspace="5" hspace="5" src="t_colorMetamerism_07.png" alt=""> <img vspace="5" hspace="5" src="t_colorMetamerism_08.png" alt=""> <h2>Compute the sensor response for these half degree bars.<a name="9"></a></h2><p>Notice that the cone absorptions are fairly constant across the horizontal line at this spatial resolution.</p><pre class="codeinput">sensor = sensorCreate(<span class="string">'human'</span>);
sensor = sensorSet(sensor,<span class="string">'exp time'</span>,0.10);
sensor = sensorSetSizeToFOV(sensor,1,uS,oi);
sensor = sensorCompute(sensor,oi);
sz = sensorGet(sensor,<span class="string">'size'</span>);
sensorPlotLine(sensor,<span class="string">'h'</span>,<span class="string">'photons'</span>,<span class="string">'space'</span>,[1,sz(1)]);
vcAddAndSelectObject(sensor); sensorWindow(<span class="string">'scale'</span>,1);
</pre><img vspace="5" hspace="5" src="t_colorMetamerism_09.png" alt=""> <img vspace="5" hspace="5" src="t_colorMetamerism_10.png" alt=""> <h2>Now, reduce the fov so the bars are an eighth of a degree.<a name="10"></a></h2><p>There is structure in thean see this more clearly if we average a few rows. Let's do it. S-cone response, higher on the left and lower on the right.  We c</p><pre class="codeinput">barS = sceneSet(barS,<span class="string">'h fov'</span>,1/4);
oi = oiCompute(oi,barS);
vcAddAndSelectObject(oi); oiWindow;

vcNewGraphWin;
oiPlot(oi,<span class="string">'h line irradiance'</span>,[10,1]);
title(<span class="string">'4 cpd bar'</span>);
</pre><img vspace="5" hspace="5" src="t_colorMetamerism_11.png" alt=""> <img vspace="5" hspace="5" src="t_colorMetamerism_12.png" alt=""> <img vspace="5" hspace="5" src="t_colorMetamerism_13.png" alt=""> <h2>END<a name="11"></a></h2><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% t_ColorMetamerism
%
% Illustrate a metameric color match.
%
% Simulate a uniform field with D65 spectral power distribution and a matching (metameric) LCD display.
%
% Then use the two metamers to create a bar pattern.
%
% Show how the bar pattern is represented after optical blurring and then captured by the human cone
% sensor array.
%
% (c) Imageval Consulting, LLC 2012

%% Initialize
ieInit;

%% Create a uniform scene with a D65 spectral power distribution
uSize = 64;
uS = sceneCreate('uniformd65',uSize);
vcAddAndSelectObject(uS); sceneWindow;

%% Create a uniform field with a metameric spectral power distribution.
% The new spectrum is the weighted sum of the primaries of an LCD.
% spectrum.  The weights are chosen so that the LCD has the same effect as
% the D65 on the cones.
%
% This new SPD is a cone metameric match to the D65 in the original scene.

% The mean LMS cone values of the original 
lms = sceneGet(uS,'lms');    
meanLMS = mean(RGB2XWFormat(lms));

% Load a display and use the display primaries as a set of basis functions
% for the metameric light.
d    = displayCreate('LCD-Apple');
wave = sceneGet(uS,'wave');
displaySPD = displayGet(d,'spd',wave);

% These are the display primaries
vcNewGraphWin; plot(wave,displaySPD)
title('Display primaries')

%% Now read the Stockman cone wavelength sensitivities
S = ieReadSpectra('stockman',wave);
dW = wave(2)-wave(1);   % Delta Wavelength

% Solve for the weights on the primaries that will produce the same
% absorptions in the cones as the D65 light.  Be careful to account for the
% wavelength sample spacing, dW.
%
%   meanLMS(:) = S'*(displaySPD*w)*dW
%
w = ((S'*displaySPD)\meanLMS(:))/dW;
metamer = displaySPD*w;

%% Create a new uniform scene with the SPD that is metameric to D65
% We do this using the sceneSPDScale routine.  This multiplies the SPD in
% the scene by another SPD.  We use the metamer/originalSPD as the
% multiplier.

% Here is the original
oSPD = sceneGet(uS,'mean energy spd');

% Divide by the original, and then multiply by the metamer
uS2 = sceneSPDScale(uS,metamer(:)./oSPD(:),'*',0);
uS2 = sceneSet(uS2,'name','metamer');

% The metamer SPD
mSPD = sceneGet(uS2,'mean energy spd');

% Make a plot comparing the metamer and the original mean energy (mn)
vcNewGraphWin;
plot(wave,mSPD,'-o',wave,oSPD,'REPLACE_WITH_DASH_DASH');
legend('Metamer','original')

% Note that the color appearance on the screen differs between these two
% metamers.  That is because I did not implement a rendering algorithm
% based on human vision and the cones.  I used a method that is faster.  I
% am thinking of changing because, well, computers are now faster.
vcAddAndSelectObject(uS2); sceneWindow;

%% Numerical check
% The comparison projects of the SPDs of the metamers onto the Stockman
% cones.  The difference should be zero.  It is small, and I am not sure
% why it is not really zero.  I could probably do better.
S'*(mSPD(:) - oSPD(:)) / norm(oSPD,2)

%% A spatial pattern with two metamers adjacent.
% This will enable us to see the effect of optical blurring on the
% different spectral power distributions.

% Retrieve the SPD data from the two different uniform scenes.
height = 64; width = 32;
xwData  = sceneGet(uS,'roi photons',  [8 8 width-1 height-1]);
xwData2 = sceneGet(uS2,'roi photons',[8 8 width-1 height-1]);

% Combine the two data sets into one and attach it to a new scene
cBar = XW2RGBFormat([xwData; xwData2],height,2*width);
barS = sceneSet(uS,'photons',cBar);

% Name it, set the FOV, and show it.
barS = sceneSet(barS,'name','bars');
barS = sceneSet(barS,'h fov',1);
vcAddAndSelectObject(barS); sceneWindow;

%% Compute the OI and show the SPD across a line in the image
% Notice that the optical image spectral irradiance varies across the row.
% The LCD spectra are clearly seen at the positive positions.  They are
% blurred a little onto the left side by the optics.
oi = oiCreate('human');
oi = oiCompute(oi,barS); 
vcNewGraphWin;
midRow = round(oiGet(oi,'rows')/2);
oiPlot(oi,'h line irradiance',[1,midRow]);
title('1 cpd bar');
vcAddAndSelectObject(oi); oiWindow;

%% Compute the sensor response for these half degree bars.
% Notice that the cone absorptions are fairly constant across the
% horizontal line at this spatial resolution.
sensor = sensorCreate('human');
sensor = sensorSet(sensor,'exp time',0.10);
sensor = sensorSetSizeToFOV(sensor,1,uS,oi);
sensor = sensorCompute(sensor,oi);
sz = sensorGet(sensor,'size');
sensorPlotLine(sensor,'h','photons','space',[1,sz(1)]);
vcAddAndSelectObject(sensor); sensorWindow('scale',1);

%% Now, reduce the fov so the bars are an eighth of a degree.
% There is structure in thean see this more clearly if we average a few rows.
% Let's do it. S-cone response, higher on the left and lower
% on the right.  We c
barS = sceneSet(barS,'h fov',1/4);
oi = oiCompute(oi,barS); 
vcAddAndSelectObject(oi); oiWindow;

vcNewGraphWin;
oiPlot(oi,'h line irradiance',[10,1]);
title('4 cpd bar');

%% END

##### SOURCE END #####
--></body></html>