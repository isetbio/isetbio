%
% RGCMosaicAnalyzer.compute.mosaicSTFsForStimulusChromaticityAndOptics
%
function mosaicSTFsForStimulusChromaticityAndOptics(...
    theMRGCMosaic, theOI, ...
    STFmeanLuminanceCdM2, ...
    STFbackgroundXYchromaticity, ...
    STFchromaticity, ...
    STFsfSupport, ...
    STFstimulusResolutionDegs, ...
    coneFundamentalsOptimizedForStimPosition, ...
    theInputConeMosaicSTFResponsesFullFileName, ...
    theMRGCMosaicSTFResponsesFullFileName, ...
    visualizeMosaicResponse, ...
    varargin)


    p = inputParser;
    p.addParameter('mRGCNonLinearityParams', [], @(x)(isempty(x))||(isstruct(x)));
    p.addParameter('customTemporalFrequencyAndContrast', [], @(x)(isempty(x))||(isstruct(x)));
    p.addParameter('displayType', '', @ischar);
    p.addParameter('displayLuminanceHeadroomPercentage', 1/100, @isscalar);
    p.addParameter('debugInputConeMosaicPcurrentResponse', false, @islogical);    
    p.addParameter('orientationDeltaDegs', 30, @isscalar);
    p.addParameter('spatialPhaseIncrementDegs', 30, @isscalar);
    p.addParameter('computeInputConeMosaicResponses', true, @islogical);
    p.addParameter('computeInputConeMosaicResponsesBasedOnConeExcitations', true, @islogical);
    p.addParameter('computeInputConeMosaicResponsesBasedOnPhotocurrents', true, @islogical);
    p.addParameter('inspectInputConeMosaicResponses', false, @islogical);
    p.addParameter('computeMRGCMosaicResponses', false, @islogical);
    p.addParameter('inspectMRGCMosaicResponses', false, @islogical);
    p.addParameter('visualizeStimulusSequence', false, @islogical);

    % Execute the parser
    p.parse(varargin{:});
    mRGCNonLinearityParams = p.Results.mRGCNonLinearityParams;
    customTemporalFrequencyAndContrast = p.Results.customTemporalFrequencyAndContrast;
    displayType = p.Results.displayType;
    displayLuminanceHeadroomPercentage = p.Results.displayLuminanceHeadroomPercentage;
    debugInputConeMosaicPcurrentResponse = p.Results.debugInputConeMosaicPcurrentResponse;
    orientationDeltaDegs = p.Results.orientationDeltaDegs;
    spatialPhaseIncrementDegs = p.Results.spatialPhaseIncrementDegs;
    computeInputConeMosaicResponses = p.Results.computeInputConeMosaicResponses;
    computeInputConeMosaicResponsesBasedOnConeExcitations = p.Results.computeInputConeMosaicResponsesBasedOnConeExcitations;
    computeInputConeMosaicResponsesBasedOnPhotocurrents = p.Results.computeInputConeMosaicResponsesBasedOnPhotocurrents;
    inspectInputConeMosaicResponses = p.Results.inspectInputConeMosaicResponses;
    computeMRGCMosaicResponses = p.Results.computeMRGCMosaicResponses;
    inspectMRGCMosaicResponses = p.Results.inspectMRGCMosaicResponses;
    visualizeStimulusSequence = p.Results.visualizeStimulusSequence;

    STFparamsStruct = struct(...
        'backgroundChromaticity', STFbackgroundXYchromaticity, ...
        'backgroundLuminanceCdM2', STFmeanLuminanceCdM2, ...
        'chromaticity', STFchromaticity, ...
        'coneFundamentalsOptimizedForStimPosition', coneFundamentalsOptimizedForStimPosition, ...
        'displayType', displayType, ...
        'displayLuminanceHeadroomPercentage', displayLuminanceHeadroomPercentage, ...
        'resolutionDegs', STFstimulusResolutionDegs, ...                       
        'positionDegs', theMRGCMosaic.eccentricityDegs, ...  
        'sizeDegs', 1.1*max(theMRGCMosaic.inputConeMosaic.sizeDegs), ...
        'sfSupport', STFsfSupport, ...
        'orientationDeltaDegs', orientationDeltaDegs, ...
        'spatialPhaseIncrementDegs', spatialPhaseIncrementDegs);


    RGCMosaicConstructor.helper.simulateExperiment.spatialTransferFunction(...
        theMRGCMosaic, theOI, ...
        STFparamsStruct, ...
        theInputConeMosaicSTFResponsesFullFileName, ...
        theMRGCMosaicSTFResponsesFullFileName, ...
        'mRGCNonLinearityParams', mRGCNonLinearityParams, ...
        'customTemporalFrequencyAndContrast', customTemporalFrequencyAndContrast, ...
        'debugInputConeMosaicPcurrentResponse', debugInputConeMosaicPcurrentResponse, ...
        'computeInputConeMosaicResponses', computeInputConeMosaicResponses, ...
        'computeInputConeMosaicResponsesBasedOnConeExcitations', computeInputConeMosaicResponsesBasedOnConeExcitations, ...
        'computeInputConeMosaicResponsesBasedOnPhotocurrents', computeInputConeMosaicResponsesBasedOnPhotocurrents, ...
        'inspectInputConeMosaicResponses', inspectInputConeMosaicResponses, ...
        'computeMRGCMosaicResponses', computeMRGCMosaicResponses, ...
        'inspectMRGCMosaicResponses', inspectMRGCMosaicResponses, ...
        'visualizeResponse', visualizeMosaicResponse, ...
        'visualizeStimulusSequence', visualizeStimulusSequence);
end

